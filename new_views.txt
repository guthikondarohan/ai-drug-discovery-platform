# NEW VIEWS FOR APP_ULTIMATE_V2.PY
# Add these before the Footer section

# === LITERATURE VIEW ===
elif st.session_state.current_view == 'literature':
    st.title("üìö Scientific Literature Search")
    st.markdown("Search PubMed for research papers about molecules and compounds")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        search_query = st.text_input(
            "üîç Search for papers",
            placeholder="Enter molecule name (e.g., aspirin, ibuprofen)..."
        )
    
    with col2:
        max_results = st.number_input("Max results", 3, 20, 10)
    
    if st.button("üöÄ Search PubMed", type="primary", use_container_width=True):
        if search_query:
            with st.spinner("Searching PubMed..."):
                try:
                    sys.path.insert(0, str(Path(__file__).parent / 'src'))
                    from research.pubmed_api import search_literature
                    
                    papers = search_literature(search_query, max_results)
                    
                    if papers:
                        st.success(f"‚úÖ Found {len(papers)} papers!")
                        
                        for i, paper in enumerate(papers, 1):
                            with st.expander(f"üìÑ {i}. {paper['title']}", expanded=i==1):
                                col1, col2 = st.columns([2, 1])
                                
                                with col1:
                                    st.markdown(f"**Authors:** {', '.join(paper['authors'][:3])}" + (" et al." if len(paper['authors']) > 3 else ""))
                                    st.markdown(f"**Journal:** {paper['journal']}")
                                
                                with col2:
                                    st.markdown(f"**Year:** {paper['year']}")
                                    st.markdown(f"**PMID:** {paper['pmid']}")
                                
                                st.markdown("**Abstract:**")
                                st.write(paper['abstract'][:500] + "..." if len(paper['abstract']) > 500 else paper['abstract'])
                                
                                st.link_button("üìñ Read on PubMed", paper['url'])
                    else:
                        st.warning("No papers found. Try a different search term.")
                except Exception as e:
                    st.error(f"Error: {str(e)}")
        else:
            st.info("üëÜ Enter a molecule name to search")

# === COMPARE VIEW ===
elif st.session_state.current_view == 'compare':
    st.title("‚öñÔ∏è Molecule Comparison")
    st.markdown("Compare multiple molecules side-by-side")
    
    st.markdown("### Enter Molecules to Compare")
    
    num_molecules = st.slider("Number of molecules", 2, 5, 3)
    
    molecules = []
    cols = st.columns(num_molecules)
    
    for i in range(num_molecules):
        with cols[i]:
            name = st.text_input(f"Name {i+1}", f"Molecule {i+1}", key=f"mol_name_{i}")
            smiles = st.text_input(f"SMILES {i+1}", key=f"mol_smiles_{i}", placeholder="CCO, CC(=O)O...")
            if name and smiles:
                molecules.append((name, smiles))
    
    if st.button("üî¨ Compare Molecules", type="primary", use_container_width=True):
        if len(molecules) >= 2:
            with st.spinner("Analyzing molecules..."):
                try:
                    sys.path.insert(0, str(Path(__file__).parent / 'src'))
                    from analysis.molecule_comparison import compare_molecules
                    
                    results = compare_molecules(molecules)
                    
                    st.success(f"‚úÖ Compared {len(molecules)} molecules!")
                    
                    st.markdown("### üìä Molecular Properties")
                    st.dataframe(results['properties_table'], use_container_width=True, hide_index=True)
                    
                    st.markdown("### üì° Radar Chart")
                    st.plotly_chart(results['radar_chart'], use_container_width=True)
                    
                except Exception as e:
                    st.error(f"Error: {str(e)}")
        else:
            st.warning("Please enter at least 2 molecules to compare")

# === EXPLAIN VIEW ===
elif st.session_state.current_view == 'explain':
    st.title("üîç Explainable AI")
    st.markdown("Understand why the model makes predictions")
    
    st.info("Uses SHAP to show which molecular features contribute to predictions")
    
    recent = st.session_state.db.get_recent_predictions(10)
    
    if recent:
        st.markdown("### Select a Prediction to Explain")
        
        df_recent = pd.DataFrame(recent)
        selected_idx = st.selectbox(
            "Choose prediction",
            range(len(df_recent)),
            format_func=lambda i: f"{df_recent.iloc[i]['smiles'][:40]} - {df_recent.iloc[i]['prediction']} ({df_recent.iloc[i]['probability']:.2%})"
        )
        
        selected = df_recent.iloc[selected_idx]
        
        st.markdown("---")
        col1, col2, col3 = st.columns(3)
        col1.metric("SMILES", selected['smiles'][:20] + "...")
        col2.metric("Prediction", selected['prediction'])
        col3.metric("Probability", f"{selected['probability']:.2%}")
        
        if st.button("üîç Explain This Prediction", type="primary"):
            st.markdown("### üí° Explanation")
            
            try:
                features = json.loads(selected['features'])
                feature_df = pd.DataFrame([
                    {"Feature": k, "Value": v}
                    for k, v in features.items()
                ])
                
                st.markdown("**Feature Values:**")
                st.dataframe(feature_df, use_container_width=True, hide_index=True)
                
                st.markdown("**Interpretation:**")
                if selected['prediction'] == 'Active':
                    st.success(f"This molecule is predicted as **ACTIVE** with {selected['probability']:.1%} confidence.")
                else:
                    st.warning(f"This molecule is predicted as **INACTIVE** with {1-selected['probability']:.1%} confidence.")
                
            except Exception as e:
                st.error(f"Error: {str(e)}")
    else:
        st.warning("No predictions in history. Make some predictions first!")

# === SEARCH VIEW ===
elif st.session_state.current_view == 'search':
    st.title("üîé Cross-Modal Search")
    st.markdown("Find similar molecules using AI")
    
    query_smiles = st.text_input("Enter SMILES to find similar molecules", placeholder="CCO, CC(=O)O...")
    
    if st.button("üîç Find Similar", type="primary"):
        if query_smiles:
            with st.spinner("Finding similar molecules..."):
                try:
                    from rdkit import Chem
                    from rdkit.Chem import AllChem, DataStructs
                    
                    query_mol = Chem.MolFromSmiles(query_smiles)
                    if query_mol:
                        st.success("‚úÖ Valid SMILES!")
                        
                        recent = st.session_state.db.get_recent_predictions(50)
                        if recent:
                            df_mols = pd.DataFrame(recent)
                            
                            similarities = []
                            query_fp = AllChem.GetMorganFingerprintAsBitVect(query_mol, 2)
                            
                            for idx, row in df_mols.iterrows():
                                mol = Chem.MolFromSmiles(row['smiles'])
                                if mol:
                                    fp = AllChem.GetMorganFingerprintAsBitVect(mol, 2)
                                    sim = DataStructs.TanimotoSimilarity(query_fp, fp)
                                    similarities.append({
                                        'smiles': row['smiles'],
                                        'similarity': sim,
                                        'prediction': row['prediction']
                                    })
                            
                            similarities.sort(key=lambda x: x['similarity'], reverse=True)
                            
                            st.markdown("### Top 5 Similar Molecules")
                            for i, result in enumerate(similarities[:5], 1):
                                cols = st.columns([3, 1])
                                with cols[0]:
                                    st.write(f"{i}. {result['smiles'][:50]}")
                                with cols[1]:
                                    st.metric("Similarity", f"{result['similarity']:.3f}")
                        else:
                            st.warning("No molecules in database to compare")
                    else:
                        st.error("Invalid SMILES")
                except Exception as e:
                    st.error(f"Error: {str(e)}")

# === GENERATE VIEW ===
elif st.session_state.current_view == 'generate':
    st.title("üß¨ Molecular Generation")
    st.markdown("Generate novel molecules using AI")
    
    st.info("VAE-based molecular generation (demo)")
    
    num_to_generate = st.slider("Number of molecules", 1, 10, 5)
    
    if st.button("üß¨ Generate Molecules", type="primary", use_container_width=True):
        with st.spinner("Generating molecules..."):
            try:
                from rdkit import Chem
                from rdkit.Chem import Descriptors
                
                st.warning("‚ö†Ô∏è VAE model not yet trained. Showing example molecules:")
                
                example_molecules = ["CCO", "CC(C)O", "CCCO", "CC(C)CO", "CCCCO", 
                                    "CC(C)(C)O", "CC(O)CO", "CCC(C)O", "CCCC(C)O", "CC(C)CCO"]
                
                generated = example_molecules[:num_to_generate]
                
                st.success(f"‚úÖ Generated {len(generated)} molecules!")
                
                for i, smiles in enumerate(generated, 1):
                    with st.expander(f"Molecule {i}: {smiles}"):
                        col1, col2 = st.columns(2)
                        
                        with col1:
                            st.code(smiles, language='text')
                            img_data = smiles_to_image(smiles)
                            if img_data:
                                st.image(img_data)
                        
                        with col2:
                            mol = Chem.MolFromSmiles(smiles)
                            if mol:
                                st.metric("Valid", "‚úÖ Yes")
                                st.metric("MW", f"{Descriptors.MolWt(mol):.1f}")
                                st.metric("LogP", f"{Descriptors.MolLogP(mol):.2f}")
                            else:
                                st.metric("Valid", "‚ùå No")
                
                st.info("üí° Train the VAE on your molecular dataset to generate truly novel molecules!")
                
            except Exception as e:
                st.error(f"Error: {str(e)}")
